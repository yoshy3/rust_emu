# Rust Cross-Platform NES Emulator

A Nintendo Entertainment System (NES) emulator written in Rust, targeting generic desktop platforms (Windows/Mac/Linux) and WebAssembly (WASM).

[**Play in Browser**](https://yoshy3.github.io/rust_emu/)

[日本語のREADMEはこちら](./README_ja.md)

> [!NOTE]
> **Vibe Coding**: This project was developed through "Vibe Coding"—a collaborative AI-native development process.
> **Acknowledgements**: Special thanks to **Gemini code assist** for providing the core reasoning, architectural guidance, and implementation support that brought this emulator to life.

## Features
- **Cross-Platform**: Runs natively on desktop and in modern web browsers.
- **Rendering**: Uses `pixels` for hardware-accelerated 2D pixel buffer rendering.
- **Web Support**: Built with `wasm-bindgen`.

## Prerequisites
- [Rust](https://www.rust-lang.org/tools/install)
- [wasm-pack](https://rustwasm.github.io/wasm-pack/installer.html) (for Web build)
- Python 3 (optional, for local web server)

## Running Locally

### Desktop
Run the emulator natively:
```bash
cargo run
```
Use `Esc` to exit.

### Web (WASM)
1. Build the project for the web:
   ```bash
   wasm-pack build --target web --no-typescript
   ```
2. Start a local server:
   ```bash
   python3 -m http.server 8000
   ```
3. Open `http://localhost:8000` in your browser.

## Controls

| NES Button | Desktop (Cargo) | Web (WASM) |
|------------|-----------------|------------|
| **A**      | `Z`             | `Z`        |
| **B**      | `X`             | `X`        |
| **Select** | `Right Shift`   | `Shift`    |
| **Start**  | `Enter`         | `Enter`    |
| **Up**     | `Up Arrow`      | `Up Arrow` |
| **Down**   | `Down Arrow`    | `Down Arrow` |
| **Left**   | `Left Arrow`    | `Left Arrow` |
| **Right**  | `Right Arrow`   | `Right Arrow` |
| **Exit**   | `Esc`           | -          |

## Project Structure
- `src/main.rs`: Desktop hardware interface (pixels + cpal).
- `src/lib.rs`: WebAssembly bridge and shared emulator instance.
- `src/cpu.rs`: 6502 CPU core with cycle-accurate opcode execution.
- `src/ppu.rs`: Picture Processing Unit logic, supporting background and sprite rendering.
- `src/apu.rs`: Audio Processing Unit with support for Pulse, Triangle, and Noise channels.
- `src/bus.rs`: System memory bus handling memory mapping and I/O.
- `src/cartridge.rs`: iNES format loader and mapper implementations.
- `src/joypad.rs`: Input state management for the NES controllers.
- `src/opcodes.rs`: Detailed instruction set and addressing mode definitions.

## Troubleshooting

### macOS "Unverified Developer" Error

If you see a message saying *"rust_emu" cannot be opened because the developer cannot be verified* or similar when running the release binary, you need to remove the quarantine attribute:

```bash
xattr -d com.apple.quarantine rust_emu
```

### Wayland Support (Linux)

If you encounter issues on Linux with Wayland related to buffer sizes or surface errors (e.g. `Buffer size must be an integer multiple of the buffer_scale`), you can try running the emulator using XWayland by unsetting the `WAYLAND_DISPLAY` environment variable:

```bash
WAYLAND_DISPLAY= cargo run -- path/to/game.nes
```

## License
MIT

## GitHub Pages Deployment (WASM)

This repository includes a GitHub Actions workflow for publishing the WASM build to GitHub Pages.

- Trigger: push a Git tag (e.g. `v0.2.1`)
- Workflow: `.github/workflows/deploy-pages.yml`
- Publish source directory (artifact root): `docs/`
- Contents copied to `docs/`: `index.html` and `pkg/` (generated by `wasm-pack`)

### One-time repository setting

In GitHub repository settings, set **Pages** source to **GitHub Actions**.

### Release flow

```bash
git tag v0.2.1
git push origin v0.2.1
```
